#!/usr/bin/env bash

set -euo pipefail

OPT_FORMAT=""
while [ $# -gt 0 ]; do
  case "$1" in
    --format)
      OPT_FORMAT="true"
      shift
      ;;
    *)
      echo "Unknown argument: $1" >&2
      exit 1
      ;;
  esac
done

# macOS's bash (3.x) can't interpolate empty arrays into parameters under
# nounset; keep command and args together as a workaround.
FOURMOLU=(fourmolu)
if [ -z "$OPT_FORMAT" ]
then
  FOURMOLU+=(--mode check)
else
  FOURMOLU+=(--mode inplace)
fi

DIR=$(cd "$(dirname "$0")" && cd .. && pwd)

readarray -t SHELL_SCRIPTS < <(grep -lER --exclude-dir .git --exclude-dir .stack-work '^#!.+(ba)?sh$' "$DIR")
shellcheck "${SHELL_SCRIPTS[@]}"

readarray -t HASKELL_SCRIPTS < <(grep -lER --exclude-dir .git --exclude-dir .stack-work '^#!.+stack$' "$DIR")
"${FOURMOLU[@]}" "${DIR}/app" "${DIR}/src" "${DIR}/test" "${HASKELL_SCRIPTS[@]}"
