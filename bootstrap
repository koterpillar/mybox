#!/usr/bin/env bash

set -euo pipefail

command_exists() {
  type -f "$1" >/dev/null 2>&1
}

case "$OSTYPE" in
  darwin*)
    if ! command_exists brew
    then
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    fi

    if ! command_exists python3
    then
      brew install python3
    fi

    for PACKAGE in coreutils gnu-tar
    do
      if [ ! -d "/usr/local/opt/$PACKAGE" ]
      then
        brew install "$PACKAGE"
      fi
      PATH="/usr/local/opt/$PACKAGE/libexec/gnubin:$PATH"
    done
 ;;
  linux*)
    DISTRO=$(grep '^ID=' /etc/os-release | cut -d = -f 2)

    case $DISTRO in
      debian)
        if ! command_exists python3
        then
          sudo apt install --yes python3{,-pip}
        fi
        ;;
      fedora)
        if ! command_exists xz
        then
          sudo dnf install --assumeyes xz
        fi
        ;;
    esac
esac

if ! python3 -c 'import pipx' >/dev/null 2>&1
then
  if ! python3 -c 'import pip' >/dev/null 2>&1
  then
    python3 -m ensurepip
  fi
  python3 -m pip install --user pipx
fi

if ! command_exists mybox
then
  python3 -m pipx install mybox
else
  python3 -m pipx upgrade mybox
fi
